{% extends "base.html" %}
{% load static %}

{% block title %}Booking Details - {{ booking.lab.name }}{% endblock %}

{% block extra_css %}
<style>
  .modal-backdrop {
    display: none !important;
  }
  .modal {
    background-color: rgba(0, 0, 0, 0.5) !important;
  }
  .modal-dialog {
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    margin: 0 !important;
    z-index: 1060 !important;
  }
  .modal-content {
    position: relative;
    z-index: 1061 !important;
  }
  
  .btn-action {
    transition: all 0.3s ease;
  }
  
  .btn-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
</style>
{% endblock %}

{% block content %}

<div class="container mt-4">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'booking_list' %}">Bookings</a></li>
      <li class="breadcrumb-item active" aria-current="page">Booking #{{ booking.id }}</li>
    </ol>
  </nav>

  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
      <i class="bi bi-calendar-event me-2"></i>
      Booking Details #{{ booking.id }}
    </h2>
    
    <!-- Status Badge -->
    <span class="badge bg-{% if booking.status == 'approved' %}success{% elif booking.status == 'pending' %}warning{% elif booking.status == 'rejected' %}danger{% elif booking.status == 'completed' %}info{% elif booking.status == 'cancelled' %}secondary{% else %}secondary{% endif %} fs-6">
      {{ booking.get_status_display|upper }}
    </span>
  </div>

  <!-- Main Content Card -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row">
        <!-- Lab Information -->
        <div class="col-md-6 mb-4">
          <h5 class="card-title border-bottom pb-2 mb-3">
            <i class="bi bi-building me-2"></i>Lab Information
          </h5>
          <div class="mb-3">
            <strong class="text-muted d-block mb-1">Lab Name</strong>
            <p class="mb-0">{{ booking.lab.name }}</p>
          </div>
          <div class="mb-3">
            <strong class="text-muted d-block mb-1">Location</strong>
            <p class="mb-0">
              <i class="bi bi-geo-alt me-1"></i>
              {{ booking.lab.location|default:"Not specified" }}
            </p>
          </div>
          <div class="mb-3">
            <strong class="text-muted d-block mb-1">Capacity</strong>
            <p class="mb-0">
              <i class="bi bi-people me-1"></i>
              {{ booking.lab.capacity }} people
            </p>
          </div>
        </div>

        <!-- Booking Information -->
        <div class="col-md-6 mb-4">
          <h5 class="card-title border-bottom pb-2 mb-3">
            <i class="bi bi-calendar-check me-2"></i>Booking Information
          </h5>
          <div class="mb-3">
            <strong class="text-muted d-block mb-1">Requested By</strong>
            <p class="mb-0">{{ booking.requester.get_full_name|default:booking.requester.username }}</p>
          </div>
          <div class="mb-3">
            <strong class="text-muted d-block mb-1">Start Date & Time</strong>
            <p class="mb-0">
              <i class="bi bi-calendar3 me-1"></i>
              {{ booking.start|date:"l, F d, Y" }}
              <br>
              <i class="bi bi-clock me-1"></i>
              {{ booking.start|date:"g:i A" }}
            </p>
          </div>
          <div class="mb-3">
            <strong class="text-muted d-block mb-1">End Date & Time</strong>
            <p class="mb-0">
              <i class="bi bi-calendar-x me-1"></i>
              {{ booking.end|date:"l, F d, Y" }}
              <br>
              <i class="bi bi-clock-fill me-1"></i>
              {{ booking.end|date:"g:i A" }}
            </p>
          </div>
          <div class="mb-3">
            <strong class="text-muted d-block mb-1">Duration</strong>
            <p class="mb-0">
              <i class="bi bi-hourglass-split me-1"></i>
              {{ duration_hours }} hours
            </p>
          </div>
          <div class="mb-3">
            <strong class="text-muted d-block mb-1">Created On</strong>
            <p class="mb-0">{{ booking.created_at|date:"M d, Y - g:i A" }}</p>
          </div>
          {% if booking.approved_by %}
          <div class="mb-3">
            <strong class="text-muted d-block mb-1">Processed By</strong>
            <p class="mb-0">{{ booking.approved_by.get_full_name|default:booking.approved_by.username }}</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Purpose/Reason -->
      {% if booking.purpose %}
      <div class="row">
        <div class="col-12">
          <h5 class="card-title border-bottom pb-2 mb-3">
            <i class="bi bi-file-text me-2"></i>Purpose
          </h5>
          <div class="bg-light p-3 rounded">
            <p class="mb-0">{{ booking.purpose }}</p>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Admin Notes -->
      {% if booking.admin_notes %}
      <div class="row mt-4">
        <div class="col-12">
          <h5 class="card-title border-bottom pb-2 mb-3">
            <i class="bi bi-chat-left-text me-2"></i>Admin Notes
          </h5>
          <div class="alert alert-{% if booking.status == 'approved' %}success{% elif booking.status == 'rejected' %}danger{% else %}info{% endif %}">
            {{ booking.admin_notes }}
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center">
        <div class="d-flex flex-wrap gap-2">
          
          <!-- Edit Button -->
          {% if user.is_superuser %}
            <!-- Superuser can edit any booking -->
            <a href="{% url 'booking_edit' booking.id %}" class="btn btn-outline-primary btn-action">
              <i class="bi bi-pencil me-1"></i>Edit Booking
            </a>
          {% elif user == booking.requester and booking.status == 'pending' %}
            <!-- Regular users can edit their own pending bookings -->
            <a href="{% url 'booking_edit' booking.id %}" class="btn btn-outline-primary btn-action">
              <i class="bi bi-pencil me-1"></i>Edit Booking
            </a>
          {% endif %}

          <!-- Approve Button (Superuser only, for pending bookings) -->
          {% if user.is_superuser and booking.status == 'pending' %}
          <button type="button" class="btn btn-success btn-action" data-bs-toggle="modal" data-bs-target="#approveModal">
            <i class="bi bi-check-circle me-1"></i>Approve
          </button>
          {% endif %}

          <!-- Reject Button (Superuser only, for pending bookings) -->
          {% if user.is_superuser and booking.status == 'pending' %}
          <button type="button" class="btn btn-danger btn-action" data-bs-toggle="modal" data-bs-target="#rejectModal">
            <i class="bi bi-x-circle me-1"></i>Reject
          </button>
          {% endif %}

          <!-- Mark as Complete (Superuser only, for approved bookings) -->
          {% if user.is_superuser and booking.status == 'approved' %}
          <button type="button" class="btn btn-info btn-action" data-bs-toggle="modal" data-bs-target="#completeModal">
            <i class="bi bi-check2-all me-1"></i>Mark as Complete
          </button>
          {% endif %}

          <!-- Cancel Button -->
          {% if booking.status not in 'cancelled,completed,rejected' %}
            {% if user.is_superuser or user == booking.requester %}
            <button type="button" class="btn btn-outline-danger btn-action" data-bs-toggle="modal" data-bs-target="#cancelModal">
              <i class="bi bi-x-circle me-1"></i>Cancel Booking
            </button>
            {% endif %}
          {% endif %}

          <!-- Delete Button (Superuser only) -->
          {% if user.is_superuser %}
          <button type="button" class="btn btn-danger btn-action" data-bs-toggle="modal" data-bs-target="#deleteModal">
            <i class="bi bi-trash me-1"></i>Delete Booking
          </button>
          {% endif %}

        </div>

        <!-- Back Button -->
        <a href="{% url 'booking_list' %}" class="btn btn-outline-secondary btn-action">
          <i class="bi bi-arrow-left me-1"></i>Back to List
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Approve Modal -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-labelledby="approveModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="approveModalLabel">
          <i class="bi bi-check-circle me-2"></i>Approve Booking
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'booking_detail' booking.id %}">
        {% csrf_token %}
        <input type="hidden" name="action" value="approve">
        <div class="modal-body">
          <p>Are you sure you want to approve this booking?</p>
          <div class="mb-3">
            <label for="approveNotes" class="form-label">Notes (Optional)</label>
            <textarea class="form-control" id="approveNotes" name="admin_notes" rows="3" placeholder="Add any notes for the requester..."></textarea>
          </div>
          <div class="alert alert-info mb-0">
            <strong>Booking Details:</strong><br>
            Lab: {{ booking.lab.name }}<br>
            Date: {{ booking.start|date:"M d, Y" }}<br>
            Time: {{ booking.start|date:"g:i A" }} - {{ booking.end|date:"g:i A" }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">
            <i class="bi bi-check-circle me-1"></i>Confirm Approval
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="rejectModalLabel">
          <i class="bi bi-x-circle me-2"></i>Reject Booking
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'booking_detail' booking.id %}">
        {% csrf_token %}
        <input type="hidden" name="action" value="reject">
        <div class="modal-body">
          <p>Are you sure you want to reject this booking?</p>
          <div class="mb-3">
            <label for="rejectReason" class="form-label">Reason for Rejection <span class="text-danger">*</span></label>
            <textarea class="form-control" id="rejectReason" name="admin_notes" rows="3" placeholder="Please provide a reason for rejection..." required></textarea>
          </div>
          <div class="alert alert-warning mb-0">
            <strong>Booking Details:</strong><br>
            Lab: {{ booking.lab.name }}<br>
            Date: {{ booking.start|date:"M d, Y" }}<br>
            Time: {{ booking.start|date:"g:i A" }} - {{ booking.end|date:"g:i A" }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-x-circle me-1"></i>Confirm Rejection
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Cancel Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title" id="cancelModalLabel">
          <i class="bi bi-exclamation-triangle me-2"></i>Cancel Booking
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'booking_detail' booking.id %}">
        {% csrf_token %}
        <input type="hidden" name="action" value="cancel">
        <div class="modal-body">
          <p>Are you sure you want to cancel this booking? This action cannot be undone.</p>
          <div class="alert alert-warning mb-0">
            <strong>Booking Details:</strong><br>
            Lab: {{ booking.lab.name }}<br>
            Date: {{ booking.start|date:"M d, Y" }}<br>
            Time: {{ booking.start|date:"g:i A" }} - {{ booking.end|date:"g:i A" }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Keep Booking</button>
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-x-circle me-1"></i>Cancel Booking
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Complete Modal -->
<div class="modal fade" id="completeModal" tabindex="-1" aria-labelledby="completeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="completeModalLabel">
          <i class="bi bi-check2-all me-2"></i>Mark Booking as Complete
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'booking_detail' booking.id %}">
        {% csrf_token %}
        <input type="hidden" name="action" value="complete">
        <div class="modal-body">
          <p>Mark this booking as completed?</p>
          <div class="mb-3">
            <label for="completeNotes" class="form-label">Completion Notes (Optional)</label>
            <textarea class="form-control" id="completeNotes" name="admin_notes" rows="3" placeholder="Add any completion notes..."></textarea>
          </div>
          <div class="alert alert-info mb-0">
            <strong>Booking Details:</strong><br>
            Lab: {{ booking.lab.name }}<br>
            Date: {{ booking.start|date:"M d, Y" }}<br>
            Time: {{ booking.start|date:"g:i A" }} - {{ booking.end|date:"g:i A" }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-info">
            <i class="bi bi-check2-all me-1"></i>Mark as Complete
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteModalLabel">
          <i class="bi bi-trash me-2"></i>Delete Booking
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'booking_delete' booking.id %}">
        {% csrf_token %}
        <div class="modal-body">
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>Warning:</strong> This action cannot be undone!
          </div>
          <p>Are you sure you want to permanently delete this booking?</p>
          <div class="alert alert-warning mb-0">
            <strong>Booking Details:</strong><br>
            ID: #{{ booking.id }}<br>
            Lab: {{ booking.lab.name }}<br>
            Requester: {{ booking.requester.get_full_name|default:booking.requester.username }}<br>
            Date: {{ booking.start|date:"M d, Y" }}<br>
            Time: {{ booking.start|date:"g:i A" }} - {{ booking.end|date:"g:i A" }}<br>
            Status: {{ booking.get_status_display }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Keep Booking</button>
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-trash me-1"></i>Delete Permanently
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- Replace the Action Buttons section in booking_detail.html -->
<!-- This shows ALL action buttons for admins regardless of current status -->

<!-- Action Buttons -->
<div class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center">
      <div class="d-flex flex-wrap gap-2">
        
        <!-- Edit Button -->
        {% if user.is_superuser or is_admin %}
          <a href="{% url 'booking_edit' booking.id %}" class="btn btn-outline-primary btn-action">
            <i class="bi bi-pencil me-1"></i>Edit Booking
          </a>
        {% elif user == booking.requester and booking.status == 'pending' %}
          <a href="{% url 'booking_edit' booking.id %}" class="btn btn-outline-primary btn-action">
            <i class="bi bi-pencil me-1"></i>Edit Booking
          </a>
        {% endif %}

        <!-- ADMIN ACTIONS - Show for all statuses -->
        {% if user.is_superuser or is_admin %}
          
          <!-- Approve Button - Show for any status except approved -->
          {% if booking.status != 'approved' %}
          <button type="button" class="btn btn-success btn-action" data-bs-toggle="modal" data-bs-target="#approveModal">
            <i class="bi bi-check-circle me-1"></i>Approve
          </button>
          {% endif %}

          <!-- Reject Button - Show for any status except rejected -->
          {% if booking.status != 'rejected' %}
          <button type="button" class="btn btn-danger btn-action" data-bs-toggle="modal" data-bs-target="#rejectModal">
            <i class="bi bi-x-circle me-1"></i>Reject
          </button>
          {% endif %}

          <!-- Complete Button - Show for any status except completed -->
          {% if booking.status != 'completed' %}
          <button type="button" class="btn btn-info btn-action" data-bs-toggle="modal" data-bs-target="#completeModal">
            <i class="bi bi-check2-all me-1"></i>Mark as Complete
          </button>
          {% endif %}

          <!-- Cancel Button - Show for any status except cancelled -->
          {% if booking.status != 'cancelled' %}
          <button type="button" class="btn btn-outline-danger btn-action" data-bs-toggle="modal" data-bs-target="#cancelModal">
            <i class="bi bi-x-circle me-1"></i>Cancel Booking
          </button>
          {% endif %}

          <!-- Reopen Button - Show for rejected/cancelled/completed -->
          {% if booking.status in 'rejected,cancelled,completed' %}
          <button type="button" class="btn btn-warning btn-action" data-bs-toggle="modal" data-bs-target="#reopenModal">
            <i class="bi bi-arrow-counterclockwise me-1"></i>Reopen
          </button>
          {% endif %}

          <!-- Delete Button - Always show for admins -->
          <button type="button" class="btn btn-danger btn-action" data-bs-toggle="modal" data-bs-target="#deleteModal">
            <i class="bi bi-trash me-1"></i>Delete Booking
          </button>

        {% elif user == booking.requester and booking.status not in 'cancelled,completed,rejected' %}
          <!-- Regular users can only cancel their own active bookings -->
          <button type="button" class="btn btn-outline-danger btn-action" data-bs-toggle="modal" data-bs-target="#cancelModal">
            <i class="bi bi-x-circle me-1"></i>Cancel Booking
          </button>
        {% endif %}

      </div>

      <!-- Back Button -->
      <a href="{% url 'booking_list' %}" class="btn btn-outline-secondary btn-action">
        <i class="bi bi-arrow-left me-1"></i>Back to List
      </a>
    </div>
  </div>
</div>

<!-- Add this NEW Reopen Modal after the other modals -->
<!-- Reopen Modal -->
<div class="modal fade" id="reopenModal" tabindex="-1" aria-labelledby="reopenModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title" id="reopenModalLabel">
          <i class="bi bi-arrow-counterclockwise me-2"></i>Reopen Booking
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'booking_detail' booking.id %}">
        {% csrf_token %}
        <input type="hidden" name="action" value="reopen">
        <div class="modal-body">
          <p>Reopen this booking and set its status back to <strong>Pending</strong>?</p>
          <div class="mb-3">
            <label for="reopenNotes" class="form-label">Notes (Optional)</label>
            <textarea class="form-control" id="reopenNotes" name="admin_notes" rows="3" placeholder="Add any notes about reopening..."></textarea>
          </div>
          <div class="alert alert-info mb-0">
            <strong>Current Status:</strong> {{ booking.get_status_display }}<br>
            <strong>New Status:</strong> Pending<br><br>
            <strong>Booking Details:</strong><br>
            Lab: {{ booking.lab.name }}<br>
            Date: {{ booking.start|date:"M d, Y" }}<br>
            Time: {{ booking.start|date:"g:i A" }} - {{ booking.end|date:"g:i A" }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">
            <i class="bi bi-arrow-counterclockwise me-1"></i>Reopen Booking
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}