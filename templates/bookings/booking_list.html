{% extends 'base.html' %}

{% block title %}My Bookings - PC Lab System{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary: #6366f1;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #3b82f6;
        --card-bg: #ffffff;
        --border-color: #e2e8f0;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
    }

    body[data-theme="dark"] {
        --card-bg: #0f172a;
        --border-color: #1e293b;
        --text-primary: #f8fafc;
        --text-secondary: #cbd5e1;
        background: #020617;
        color: #f8fafc;
    }

    body[data-theme="dark"] .bookings-hero {
        background: linear-gradient(135deg, #4338ca 0%, #581c87 100%);
    }

    body[data-theme="dark"] .stat-card,
    body[data-theme="dark"] .control-panel,
    body[data-theme="dark"] .filter-panel,
    body[data-theme="dark"] .bookings-table-wrapper {
        background: #0f172a;
        border-color: #1e293b;
    }

    body[data-theme="dark"] .search-input,
    body[data-theme="dark"] .sort-btn,
    body[data-theme="dark"] .filter-btn,
    body[data-theme="dark"] select {
        background: #1e293b;
        color: #f8fafc;
        border-color: #334155;
    }

    body[data-theme="dark"] .bookings-table tbody tr:hover {
        background: rgba(102, 126, 234, 0.1);
    }

    body[data-theme="dark"] .booking-id {
        background: rgba(102, 126, 234, 0.25);
        color: #f8fafc;
    }

    body[data-theme="dark"] .filter-tag {
        background: rgba(102, 126, 234, 0.2);
        border-color: rgba(102, 126, 234, 0.4);
    }

    body[data-theme="dark"] .filter-tag button {
        color: #f8fafc;
    }

    body {
        background: #f8fafc;
        color: var(--text-primary);
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .bookings-hero {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 25px;
        padding: 3rem;
        margin-bottom: 2rem;
        color: white;
        box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4);
    }

    .hero-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 2rem;
    }

    .hero-text h2 {
        font-size: 2.5rem;
        font-weight: 900;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .hero-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
    }

    .hero-btn {
        padding: 0.875rem 2rem;
        border-radius: 15px;
        font-weight: 700;
        border: 2px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.2);
        color: white;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
    }

    .hero-btn:hover {
        background: white;
        color: #667eea;
        transform: translateY(-3px);
    }

    .stats-dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        border: 2px solid var(--border-color);
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 900;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: 0.95rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .control-panel {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        border: 2px solid var(--border-color);
    }

    .control-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .control-title {
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .dark-mode-toggle {
        width: 60px;
        height: 32px;
        background: #e2e8f0;
        border-radius: 20px;
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .dark-mode-toggle.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .dark-mode-toggle::before {
        content: '‚òÄÔ∏è';
        position: absolute;
        width: 26px;
        height: 26px;
        background: white;
        border-radius: 50%;
        top: 3px;
        left: 3px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .dark-mode-toggle.active::before {
        content: 'üåô';
        left: calc(100% - 29px);
    }

    .controls-section {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;
        gap: 1rem;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .search-box {
        position: relative;
    }

    .search-input {
        width: 100%;
        padding: 0.875rem 1.25rem 0.875rem 3.5rem;
        border: 2px solid var(--border-color);
        border-radius: 15px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: var(--card-bg);
        color: var(--text-primary);
    }

    .search-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .search-icon {
        position: absolute;
        left: 1.25rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        font-size: 1.1rem;
    }

    .sort-btn,
    .filter-btn,
    select {
        padding: 0.875rem 1.5rem;
        border: 2px solid var(--border-color);
        border-radius: 15px;
        background: var(--card-bg);
        color: var(--text-primary);
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        justify-content: center;
        white-space: nowrap;
        font-size: 0.95rem;
    }

    select {
        display: block;
        width: 100%;
    }

    .sort-btn:hover,
    .filter-btn:hover,
    select:hover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.05);
    }

    .filter-panel {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        border: 2px solid var(--border-color);
        display: none;
    }

    .filter-panel.active {
        display: block;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .filter-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
        font-size: 0.9rem;
    }

    .filter-group input,
    .filter-group select {
        width: 100%;
    }

    .filter-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .filter-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(102, 126, 234, 0.1);
        border: 2px solid rgba(102, 126, 234, 0.3);
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .filter-tag button {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--text-primary);
        font-size: 1.2rem;
        padding: 0;
        line-height: 1;
    }

    .filter-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    .btn-reset {
        padding: 0.75rem 1.5rem;
        background: var(--border-color);
        color: var(--text-primary);
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-reset:hover {
        background: var(--text-secondary);
        color: white;
    }

    .bookings-table-wrapper {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 0;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        border: 2px solid var(--border-color);
        margin-bottom: 2rem;
    }

    .table-container {
        overflow-x: auto;
    }

    .bookings-table {
        width: 100%;
        border-collapse: collapse;
    }

    .bookings-table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .bookings-table thead th {
        padding: 1.25rem 1.5rem;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 1px;
        color: white;
        text-align: left;
        white-space: nowrap;
    }

    .bookings-table tbody tr {
        border-bottom: 1px solid var(--border-color);
        transition: all 0.2s ease;
    }

    .bookings-table tbody tr:hover {
        background: rgba(102, 126, 234, 0.05);
    }

    .bookings-table tbody td {
        padding: 1.25rem 1.5rem;
        color: var(--text-primary);
        font-weight: 500;
        vertical-align: middle;
    }

    .booking-id {
        font-weight: 800;
        color: var(--text-primary);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 10px;
        transition: all 0.3s ease;
    }

    .booking-id:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transform: translateX(5px);
    }

    .lab-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-radius: 10px;
        font-weight: 700;
        font-size: 0.9rem;
    }

    .datetime-cell {
        display: flex;
        flex-direction: column;
        gap: 0.375rem;
    }

    .date {
        font-weight: 700;
        color: var(--text-primary);
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }

    .time {
        font-size: 0.85rem;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }

    .duration {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-primary);
        font-weight: 600;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 10px;
        font-weight: 700;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-pending {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        color: #92400e;
    }

    .status-approved {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #065f46;
    }

    .status-rejected {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #991b1b;
    }

    .status-completed {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #1e40af;
    }

    .status-cancelled {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #991b1b;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .action-btn {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
        text-decoration: none;
    }

    .action-btn-view {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .action-btn-edit {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: white;
    }

    .action-btn-copy {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
    }

    .action-btn:hover {
        transform: translateY(-3px) scale(1.1);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    .table-footer {
        padding: 1.5rem;
        background: var(--card-bg);
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 0 0 20px 20px;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .result-count {
        color: var(--text-secondary);
        font-weight: 600;
    }

    .export-btn {
        padding: 0.75rem 1.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .export-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .empty-state {
        text-align: center;
        padding: 5rem 2rem;
    }

    .empty-icon {
        font-size: 6rem;
        margin-bottom: 1.5rem;
    }

    .empty-title {
        font-size: 2rem;
        font-weight: 900;
        color: var(--text-primary);
        margin-bottom: 1rem;
    }

    .empty-text {
        color: var(--text-secondary);
        font-size: 1.1rem;
        margin-bottom: 2rem;
    }

    .toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background: #10b981;
        color: white;
        padding: 1.25rem 1.75rem;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (max-width: 1024px) {
        .controls-section {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .hero-text h2 {
            font-size: 2rem;
        }
        .stats-dashboard {
            grid-template-columns: 1fr;
        }
        .filter-grid {
            grid-template-columns: 1fr;
        }
        .table-container {
            overflow-x: scroll;
        }
        .bookings-table {
            min-width: 900px;
        }
        .table-footer {
            flex-direction: column;
            gap: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Hero Section -->
    <div class="bookings-hero">
        <div class="hero-content">
            <div class="hero-text">
                <h2><i class="bi bi-calendar-check-fill"></i> My Bookings</h2>
                <p class="hero-subtitle">Manage and track your lab reservations</p>
            </div>
            <div>
                <a href="{% url 'booking_create' %}" class="hero-btn">
                    <i class="bi bi-plus-circle-fill"></i>
                    <span>New Booking</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Stats Dashboard -->
    <div class="stats-dashboard">
        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <i class="bi bi-calendar-range"></i>
                </div>
            </div>
            <div class="stat-value">{{ bookings|length }}</div>
            <div class="stat-label">Total Bookings</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                    <i class="bi bi-clock-history"></i>
                </div>
            </div>
            <div class="stat-value" id="pendingCount">0</div>
            <div class="stat-label">Pending</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                    <i class="bi bi-check-circle-fill"></i>
                </div>
            </div>
            <div class="stat-value" id="approvedCount">0</div>
            <div class="stat-label">Approved</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
                    <i class="bi bi-check-all"></i>
                </div>
            </div>
            <div class="stat-value" id="completedCount">0</div>
            <div class="stat-label">Completed</div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="control-panel">
        <div class="control-header">
            <h3 class="control-title">
                <i class="bi bi-sliders"></i> Control Center
            </h3>
            <div class="dark-mode-toggle" id="darkModeToggle"></div>
        </div>

        <div class="controls-section">
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="Search by ID, Lab, or Date...">
                <i class="bi bi-search search-icon"></i>
            </div>

            <button class="sort-btn" id="sortBtn">
                <i class="bi bi-arrow-down-up" id="sortIcon"></i>
                <span id="sortText">Date</span>
            </button>

            <button class="filter-btn" id="filterBtn">
                <i class="bi bi-funnel-fill"></i>
                <span>Filters</span>
            </button>
        </div>

        <!-- Advanced Filters -->
        <div class="filter-panel" id="filterPanel">
            <div class="filter-grid">
                <div class="filter-group">
                    <label>Status</label>
                    <select id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="completed">Completed</option>
                        <option value="rejected">Rejected</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Lab Name</label>
                    <select id="labFilter">
                        <option value="">All Labs</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Date From</label>
                    <input type="date" id="dateFromFilter">
                </div>

                <div class="filter-group">
                    <label>Date To</label>
                    <input type="date" id="dateToFilter">
                </div>

                <div class="filter-group">
                    <label>Duration</label>
                    <select id="durationFilter">
                        <option value="">All Durations</option>
                        <option value="short">Less than 1 hour</option>
                        <option value="medium">1-3 hours</option>
                        <option value="long">3+ hours</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Sort By</label>
                    <select id="sortByFilter">
                        <option value="date-desc">Newest First</option>
                        <option value="date-asc">Oldest First</option>
                        <option value="duration-desc">Longest Duration</option>
                        <option value="status">Status (A-Z)</option>
                    </select>
                </div>
            </div>

            <div class="filter-tags" id="filterTags"></div>

            <div class="filter-actions">
                <button class="btn-reset" id="resetFiltersBtn">Reset All Filters</button>
            </div>
        </div>
    </div>

    <!-- Table View -->
    <div class="bookings-table-wrapper">
        {% if bookings %}
        <div class="table-container">
            <table class="bookings-table">
                <thead>
                    <tr>
                        <th><i class="bi bi-hash"></i> ID</th>
                        <th><i class="bi bi-building"></i> Lab</th>
                        <th><i class="bi bi-calendar-event"></i> Start</th>
                        <th><i class="bi bi-calendar-x"></i> End</th>
                        <th><i class="bi bi-hourglass-split"></i> Duration</th>
                        <th><i class="bi bi-info-circle"></i> Status</th>
                        <th><i class="bi bi-gear"></i> Actions</th>
                    </tr>
                </thead>
                <tbody id="bookingsTableBody">
                    {% for b in bookings %}
                    <tr data-status="{{ b.status|lower }}" data-id="{{ b.id }}" data-date="{{ b.start|date:'Y-m-d' }}" data-lab="{{ b.lab.name|default:'N/A'|lower }}" data-duration="{% widthratio b.duration_hours 1 1 %}">
                        <td>
                            <a href="{% url 'booking_detail' b.id %}" class="booking-id">
                                <i class="bi bi-link-45deg"></i>
                                <span>#{{ b.id }}</span>
                            </a>
                        </td>
                        <td>
                            <span class="lab-badge">
                                <i class="bi bi-building"></i>
                                <span>{{ b.lab.name|default:"N/A" }}</span>
                            </span>
                        </td>
                        <td>
                            <div class="datetime-cell">
                                <span class="date">
                                    <i class="bi bi-calendar-check"></i>
                                    {{ b.start|date:"M d, Y" }}
                                </span>
                                <span class="time">
                                    <i class="bi bi-clock"></i>
                                    {{ b.start|date:"h:i A" }}
                                </span>
                            </div>
                        </td>
                        <td>
                            <div class="datetime-cell">
                                <span class="date">
                                    <i class="bi bi-calendar-x"></i>
                                    {{ b.end|date:"M d, Y" }}
                                </span>
                                <span class="time">
                                    <i class="bi bi-clock-fill"></i>
                                    {{ b.end|date:"h:i A" }}
                                </span>
                            </div>
                        </td>
                        <td>
                            <div class="duration">
                                <i class="bi bi-hourglass-split"></i>
                                <span>{{ b.duration_hours }} hrs</span>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge status-{{ b.status|lower }}">
                                {% if b.status == "pending" %}
                                <i class="bi bi-clock-fill"></i>
                                {% elif b.status == "approved" %}
                                <i class="bi bi-check-circle-fill"></i>
                                {% elif b.status == "rejected" %}
                                <i class="bi bi-x-circle-fill"></i>
                                {% elif b.status == "completed" %}
                                <i class="bi bi-check-all"></i>
                                {% elif b.status == "cancelled" %}
                                <i class="bi bi-x-circle-fill"></i>
                                {% endif %}
                                {{ b.get_status_display }}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a href="{% url 'booking_detail' b.id %}" class="action-btn action-btn-view" title="View Details">
                                    <i class="bi bi-eye-fill"></i>
                                </a>
                                {% if is_admin %}
                                    <!-- Admins can edit any booking -->
                                    <a href="{% url 'booking_edit' b.id %}" class="action-btn action-btn-edit" title="Edit Booking">
                                        <i class="bi bi-pencil-fill"></i>
                                    </a>
                                {% elif b.status == "pending" and user == b.requester %}
                                    <!-- Regular users can only edit their own pending bookings -->
                                    <a href="{% url 'booking_edit' b.id %}" class="action-btn action-btn-edit" title="Edit Booking">
                                        <i class="bi bi-pencil-fill"></i>
                                    </a>
                                {% endif %}
                                <button class="action-btn action-btn-copy" onclick="copyBookingId('{{ b.id }}')" title="Copy ID">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="table-footer">
            <div class="result-count">
                <span id="resultCount">{{ bookings|length }}</span> bookings found
            </div>
            <button class="export-btn" onclick="exportToCSV()">
                <i class="bi bi-download"></i> Export CSV
            </button>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">üìÖ</div>
            <h3 class="empty-title">No Bookings Found</h3>
            <p class="empty-text">Start by creating your first lab reservation!</p>
            <a href="{% url 'booking_create' %}" class="hero-btn">
                <i class="bi bi-plus-circle-fill"></i> Create New Booking
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ============ UTILITIES ============
function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function copyBookingId(id) {
    navigator.clipboard.writeText('#' + id);
    showToast('Booking ID copied to clipboard!');
}

// ============ STATISTICS ============
function updateStats() {
    const rows = document.querySelectorAll('#bookingsTableBody tr:not([style*="display: none"])');
    let pending = 0, approved = 0, completed = 0;
    
    rows.forEach(row => {
        const status = row.dataset.status;
        if (status === 'pending') pending++;
        if (status === 'approved') approved++;
        if (status === 'completed') completed++;
    });
    
    document.getElementById('pendingCount').textContent = pending;
    document.getElementById('approvedCount').textContent = approved;
    document.getElementById('completedCount').textContent = completed;
    document.getElementById('resultCount').textContent = rows.length;
}

// ============ DARK MODE ============
const darkModeToggle = document.getElementById('darkModeToggle');
if (darkModeToggle) {
    darkModeToggle.addEventListener('click', function() {
        this.classList.toggle('active');
        const theme = this.classList.contains('active') ? 'dark' : 'light';
        document.body.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
    });
}

const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'dark' && darkModeToggle) {
    darkModeToggle.classList.add('active');
    document.body.setAttribute('data-theme', 'dark');
}

// ============ LABS EXTRACTION ============
function populateLabFilter() {
    const rows = document.querySelectorAll('#bookingsTableBody tr');
    const labs = new Set();
    
    rows.forEach(row => {
        const lab = row.dataset.lab;
        if (lab) labs.add(lab);
    });
    
    const labFilter = document.getElementById('labFilter');
    Array.from(labs).sort().forEach(lab => {
        const option = document.createElement('option');
        option.value = lab;
        option.textContent = lab.charAt(0).toUpperCase() + lab.slice(1);
        labFilter.appendChild(option);
    });
}

// ============ FILTERS & SEARCH ============
const filterBtn = document.getElementById('filterBtn');
const filterPanel = document.getElementById('filterPanel');

if (filterBtn) {
    filterBtn.addEventListener('click', function() {
        filterPanel.classList.toggle('active');
    });
}

const searchInput = document.getElementById('searchInput');
const statusFilter = document.getElementById('statusFilter');
const labFilter = document.getElementById('labFilter');
const dateFromFilter = document.getElementById('dateFromFilter');
const dateToFilter = document.getElementById('dateToFilter');
const durationFilter = document.getElementById('durationFilter');

function applyFilters() {
    const searchTerm = searchInput.value.toLowerCase();
    const statusValue = statusFilter.value;
    const labValue = labFilter.value;
    const dateFrom = dateFromFilter.value;
    const dateTo = dateToFilter.value;
    const durationValue = durationFilter.value;
    
    const rows = document.querySelectorAll('#bookingsTableBody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const status = row.dataset.status;
        const lab = row.dataset.lab;
        const date = row.dataset.date;
        const duration = parseInt(row.dataset.duration);
        
        let show = true;
        
        // Search filter
        if (searchTerm && !text.includes(searchTerm)) {
            show = false;
        }
        
        // Status filter
        if (statusValue && status !== statusValue) {
            show = false;
        }
        
        // Lab filter
        if (labValue && lab !== labValue) {
            show = false;
        }
        
        // Date range filter
        if (dateFrom && date < dateFrom) {
            show = false;
        }
        if (dateTo && date > dateTo) {
            show = false;
        }
        
        // Duration filter
        if (durationValue) {
            if (durationValue === 'short' && duration >= 1) show = false;
            if (durationValue === 'medium' && (duration < 1 || duration > 3)) show = false;
            if (durationValue === 'long' && duration <= 3) show = false;
        }
        
        row.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    });
    
    updateStats();
    updateFilterTags();
}

function updateFilterTags() {
    const tagsContainer = document.getElementById('filterTags');
    tagsContainer.innerHTML = '';
    
    const filters = [];
    
    if (searchInput.value) {
        filters.push({ label: `Search: "${searchInput.value}"`, clear: () => { searchInput.value = ''; applyFilters(); } });
    }
    if (statusFilter.value) {
        filters.push({ label: `Status: ${statusFilter.options[statusFilter.selectedIndex].text}`, clear: () => { statusFilter.value = ''; applyFilters(); } });
    }
    if (labFilter.value) {
        filters.push({ label: `Lab: ${labFilter.options[labFilter.selectedIndex].text}`, clear: () => { labFilter.value = ''; applyFilters(); } });
    }
    if (dateFromFilter.value) {
        filters.push({ label: `From: ${dateFromFilter.value}`, clear: () => { dateFromFilter.value = ''; applyFilters(); } });
    }
    if (dateToFilter.value) {
        filters.push({ label: `To: ${dateToFilter.value}`, clear: () => { dateToFilter.value = ''; applyFilters(); } });
    }
    if (durationFilter.value) {
        filters.push({ label: `Duration: ${durationFilter.options[durationFilter.selectedIndex].text}`, clear: () => { durationFilter.value = ''; applyFilters(); } });
    }
    
    filters.forEach(filter => {
        const tag = document.createElement('div');
        tag.className = 'filter-tag';
        tag.innerHTML = `${filter.label} <button type="button">‚úï</button>`;
        tag.querySelector('button').addEventListener('click', filter.clear);
        tagsContainer.appendChild(tag);
    });
}

if (searchInput) searchInput.addEventListener('input', applyFilters);
if (statusFilter) statusFilter.addEventListener('change', applyFilters);
if (labFilter) labFilter.addEventListener('change', applyFilters);
if (dateFromFilter) dateFromFilter.addEventListener('change', applyFilters);
if (dateToFilter) dateToFilter.addEventListener('change', applyFilters);
if (durationFilter) durationFilter.addEventListener('change', applyFilters);

const resetFiltersBtn = document.getElementById('resetFiltersBtn');
if (resetFiltersBtn) {
    resetFiltersBtn.addEventListener('click', function() {
        searchInput.value = '';
        statusFilter.value = '';
        labFilter.value = '';
        dateFromFilter.value = '';
        dateToFilter.value = '';
        durationFilter.value = '';
        applyFilters();
    });
}

// ============ SORTING ============
let currentSort = 'date-desc';
const sortByFilter = document.getElementById('sortByFilter');

if (sortByFilter) {
    sortByFilter.addEventListener('change', function() {
        currentSort = this.value;
        applySorting();
    });
}

function applySorting() {
    const tbody = document.getElementById('bookingsTableBody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
        let comparison = 0;
        
        if (currentSort === 'date-desc') {
            comparison = new Date(b.dataset.date) - new Date(a.dataset.date);
        } else if (currentSort === 'date-asc') {
            comparison = new Date(a.dataset.date) - new Date(b.dataset.date);
        } else if (currentSort === 'duration-desc') {
            comparison = parseInt(b.dataset.duration) - parseInt(a.dataset.duration);
        } else if (currentSort === 'status') {
            comparison = a.dataset.status.localeCompare(b.dataset.status);
        }
        
        return comparison;
    });
    
    rows.forEach(row => tbody.appendChild(row));
}

// ============ EXPORT TO CSV ============
function exportToCSV() {
    const rows = document.querySelectorAll('#bookingsTableBody tr:not([style*="display: none"])');
    let csv = 'ID,Lab,Start Date,Start Time,End Date,End Time,Duration (hrs),Status\n';
    
    rows.forEach(row => {
        const id = row.dataset.id;
        const lab = row.dataset.lab;
        const tds = row.querySelectorAll('td');
        
        const startDate = tds[2].querySelector('.date')?.textContent.trim() || '';
        const startTime = tds[2].querySelector('.time')?.textContent.trim() || '';
        const endDate = tds[3].querySelector('.date')?.textContent.trim() || '';
        const endTime = tds[3].querySelector('.time')?.textContent.trim() || '';
        const duration = tds[4].querySelector('.duration span')?.textContent.trim() || '';
        const status = tds[5].querySelector('.status-badge')?.textContent.trim() || '';
        
        csv += `"${id}","${lab}","${startDate}","${startTime}","${endDate}","${endTime}","${duration}","${status}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `bookings-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
    showToast('Bookings exported successfully!');
}

// ============ INITIALIZATION ============
document.addEventListener('DOMContentLoaded', function() {
    populateLabFilter();
    updateStats();
    updateFilterTags();
});
</script>
{% endblock %}